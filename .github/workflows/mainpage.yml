name: Anasayfa GÃ¼ncelleme

on:
  push:
    paths:
      - 'birbakista.json'
      - 'soylesikayitlari.json'
    branches:
      - main

jobs:
  update-homepage:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Update Homepage JSON (Enhanced)
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        // DeÄŸiÅŸen dosyalarÄ± tespit et
        const { execSync } = require('child_process');
        let changedFiles = [];
        try {
          const gitDiff = execSync('git diff --name-only HEAD~1 HEAD', { encoding: 'utf8' });
          changedFiles = gitDiff.trim().split('\n').filter(f => f.endsWith('.json'));
        } catch (error) {
          console.log('Git diff alÄ±namadÄ±, tÃ¼m dosyalar iÅŸlenecek');
          changedFiles = ['birbakista.json', 'soylesikayitlari.json'];
        }
        
        // Mevcut anasayfa.json dosyasÄ±nÄ± oku
        let homepage = {
          son_guncelleme: new Date().toISOString(),
          isaretler: {
            taze: []
          }
        };
        
        if (fs.existsSync('anasayfa.json')) {
          try {
            homepage = JSON.parse(fs.readFileSync('anasayfa.json', 'utf8'));
          } catch (error) {
            console.log('Mevcut anasayfa.json okunamadÄ±, yeni bir tane oluÅŸturuluyor...');
          }
        }
        
        // Ä°stenmeyen alanlarÄ± kaldÄ±r
        delete homepage.istatistik;
        delete homepage.sÃ¼rÃ¼m;
        
        // Adetler iÃ§in nesneyi baÅŸlat
        let adetler = {
          birbakista: 0,
          soylesikayitlari: 0
        };
        
        // Ä°ÅŸlenecek dosyalar
        const filesToProcess = [
          { path: 'birbakista.json', name: 'birbakista.json' },
          { path: 'soylesikayitlari.json', name: 'soylesikayitlari.json' }
        ];
        
        let processedFiles = 0;
        
        // Her dosyayÄ± iÅŸle
        filesToProcess.forEach(file => {
          if (fs.existsSync(file.path)) {
            try {
              const data = JSON.parse(fs.readFileSync(file.path, 'utf8'));
              
              // Adet bilgisini gÃ¼ncelle
              const baseName = path.basename(file.path, '.json');
              if (adetler.hasOwnProperty(baseName)) {
                adetler[baseName] = Array.isArray(data.isaretler) ? data.isaretler.length : 0;
              }
              
              if (data.isaretler && Array.isArray(data.isaretler)) {
                // DosyanÄ±n son gÃ¼ncellenme zamanÄ±nÄ± al
                const fileStats = fs.statSync(file.path);
                const fileLastModified = fileStats.mtime.toISOString();
                
                // ID'leri bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe sÄ±rala, sadece 20 ile baÅŸlayanlarÄ± al ve ilk 3'Ã¼nÃ¼ seÃ§
                const sortedItems = data.isaretler
                  .filter(item => item.id !== undefined && item.id !== null && item.id.toString().startsWith('20'))
                  .sort((a, b) => b.id - a.id)
                  .slice(0, 3)
                  .map(item => ({
                    id: item.id,
                    text: item.text ? item.text.substring(0, 50) + (item.text.length > 50 ? '...' : '') : ''
                  }));
                
                // Anasayfa verisinde bu dosya iÃ§in olan kaydÄ± bul veya oluÅŸtur
                const existingIndex = homepage.isaretler.taze.findIndex(item => item.yol === file.name);
                
                const updateData = {
                  yol: file.name,
                  tazeler: sortedItems,
                  son_guncelleme: fileLastModified
                };
                
                if (existingIndex !== -1) {
                  homepage.isaretler.taze[existingIndex] = updateData;
                } else {
                  homepage.isaretler.taze.push(updateData);
                }
                
                processedFiles++;
                console.log(`${file.name} iÅŸlendi: ${sortedItems.length} taze ID (20 ile baÅŸlayan)`);
              }
            } catch (error) {
              console.error(`${file.name} iÅŸlenirken hata oluÅŸtu:`, error.message);
            }
          }
        });
        
        // Adetler alanÄ±nÄ± homepage'e ekle
        homepage.adetler = adetler;
        
        // Genel son gÃ¼ncelleme zamanÄ±nÄ± ayarla
        homepage.son_guncelleme = new Date().toISOString();
        
        // anasayfa.json dosyasÄ±nÄ± gÃ¼ncelle
        fs.writeFileSync('anasayfa.json', JSON.stringify(homepage, null, 2));
        console.log(`anasayfa.json gÃ¼ncellendi - ${processedFiles} dosya iÅŸlendi`);
        EOF
    
    - name: Validate JSON
      run: |
        # JSON dosyasÄ±nÄ±n geÃ§erli olduÄŸunu kontrol et
        if ! jq empty anasayfa.json 2>/dev/null; then
          echo "âŒ anasayfa.json geÃ§ersiz JSON formatÄ±nda!"
          exit 1
        else
          echo "âœ… JSON formatÄ± geÃ§erli"
        fi
    
    - name: Commit and Push Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add anasayfa.json
        
        # DeÄŸiÅŸiklik var mÄ± kontrol et
        if git diff --staged --quiet; then
          echo "â„¹ï¸ Herhangi bir deÄŸiÅŸiklik yok"
        else
          # Hangi dosyalarÄ±n deÄŸiÅŸtiÄŸini commit mesajÄ±na ekle
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '(birbakista|soylesikayitlari)\.json' | tr '\n' ' ')
          git commit -m "ğŸ”„ Anasayfa gÃ¼ncellendi

          DeÄŸiÅŸen dosyalar: $CHANGED_FILES
          GÃ¼ncelleme zamanÄ±: $(date '+%Y-%m-%d %H:%M:%S')"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          echo "âœ… DeÄŸiÅŸiklikler commit edildi ve push yapÄ±ldÄ±"
        fi
